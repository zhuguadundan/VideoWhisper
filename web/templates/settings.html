<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API设置 - 智能视频转文本处理平台</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        /* 覆盖深蓝色背景，使用白色背景 */
        body {
            background: #ffffff !important;
            min-height: 100vh;
        }
        
        .bg-gradient {
            display: none !important;
        }
        
        /* 调整按钮样式适应白色背景 */
        .btn-outline-primary {
            color: #0d6efd;
            border-color: #0d6efd;
        }
        
        .btn-outline-primary:hover {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: #ffffff;
        }
        
        .btn-outline-secondary {
            color: #6c757d;
            border-color: #6c757d;
        }
        
        .btn-outline-secondary:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #ffffff;
        }
        
        .security-notice {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            border-left: 4px solid #e17055;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .api-section {
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: rgba(255, 255, 255, 0.7);
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: none;
            color: #6c757d;
            cursor: pointer;
        }
        .test-button {
            width: 100%;
            margin-top: 10px;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-untested { background-color: #6c757d; }
        
        /* Toast 通知样式 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #dee2e6;
        }
        .toast-success { border-left: 4px solid #28a745; }
        .toast-error { border-left: 4px solid #dc3545; }
        .toast-warning { border-left: 4px solid #ffc107; }
        
        .toast-header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0,0,0,0.03);
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
        }
        .toast-body {
            padding: 12px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- 导航 -->
                <div class="mb-4">
                    <div class="btn-group">
                        <a href="/" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>返回首页
                        </a>
                        <a href="/files" class="btn btn-outline-secondary">
                            <i class="fas fa-folder me-2"></i>文件管理
                        </a>
                    </div>
                </div>

                <!-- 标题 -->
                <div class="text-center mb-5">
                    <h1><i class="fas fa-cog me-3"></i>API设置</h1>
                    <p class="text-muted">配置您的AI服务API密钥和访问地址</p>
                </div>

                <!-- 安全提示 -->
                <div class="security-notice">
                    <h6><i class="fas fa-shield-alt me-2"></i>安全提醒</h6>
                    <ul class="mb-0">
                        <li>API密钥仅保存在您的浏览器本地存储中，不会上传到服务器</li>
                        <li>请定期更换API密钥以确保账户安全</li>
                        <li>建议使用专门的API子账户，限制权限范围</li>
                        <li>如在公共设备使用，请及时清除浏览器数据</li>
                    </ul>
                </div>

                <!-- 配置表单 -->
                <form id="apiConfigForm">
                    <!-- 语音识别API配置 -->
                    <div class="api-section">
                        <h5 class="mb-3">
                            <i class="fas fa-microphone me-2"></i>语音识别服务 (硅基流动)
                            <span class="status-indicator status-untested" id="siliconflow-status"></span>
                            <small class="text-muted" id="siliconflow-status-text">未测试</small>
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">API Key</label>
                                <div class="position-relative">
                                    <input type="password" class="form-control" id="siliconflow_api_key" 
                                           placeholder="输入硅基流动API Key">
                                    <button type="button" class="toggle-password" 
                                            onclick="togglePasswordVisibility('siliconflow_api_key')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Base URL</label>
                                <input type="url" class="form-control" id="siliconflow_base_url" 
                                       value="https://api.siliconflow.cn/v1" placeholder="API基础URL">
                            </div>
                            <div class="col-12">
                                <label class="form-label">模型名称</label>
                                <input type="text" class="form-control" id="siliconflow_model" 
                                       value="FunAudioLLM/SenseVoiceSmall" placeholder="语音识别模型">
                            </div>
                            <div class="col-12">
                                <button type="button" class="btn btn-outline-success test-button" 
                                        onclick="testConnection('siliconflow')">
                                    <i class="fas fa-check-circle me-2"></i>测试连接
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- YouTube Cookies 配置 -->
                    <div class="api-section">
                        <h5 class="mb-3">
                            <i class="fab fa-youtube me-2"></i>YouTube Cookies 配置
                            <span class="status-indicator status-untested" id="youtube-status"></span>
                            <small class="text-muted" id="youtube-status-text">可选配置</small>
                        </h5>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>说明：</strong>当遇到"机器人验证"错误时，需要配置 YouTube cookies。cookies 仅保存在浏览器本地，不会上传到服务器。
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">
                                    YouTube Cookies <small class="text-muted">(从浏览器开发者工具复制)</small>
                                </label>
                                <textarea class="form-control" id="youtube_cookies" rows="6" 
                                          placeholder="粘贴从浏览器开发者工具复制的 YouTube cookies...&#10;格式：name1=value1; name2=value2; ...&#10;&#10;获取方法：&#10;1. 在浏览器中访问 YouTube.com 并登录&#10;2. 按F12打开开发者工具&#10;3. 进入 Application/Storage 标签页&#10;4. 点击 Cookies -> https://www.youtube.com&#10;5. 复制所有 cookie 值"></textarea>
                            </div>
                            <div class="col-12">
                                <button type="button" class="btn btn-outline-info me-2" onclick="showCookieGuide()">
                                    <i class="fas fa-question-circle me-2"></i>获取指南
                                </button>
                                <button type="button" class="btn btn-outline-warning me-2" onclick="clearYoutubeCookies()">
                                    <i class="fas fa-trash me-2"></i>清除 Cookies
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="testYoutubeCookies()">
                                    <i class="fas fa-check-circle me-2"></i>测试 Cookies
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- AI文本处理服务配置 -->
                    <div class="api-section">
                        <h5 class="mb-3">
                            <i class="fas fa-brain me-2"></i>AI文本处理服务
                            <span class="status-indicator status-untested" id="text_processor-status"></span>
                            <small class="text-muted" id="text_processor-status-text">未测试</small>
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">服务提供商</label>
                                <select class="form-select" id="text_processor_provider" onchange="onProviderChange()">
                                    <option value="siliconflow" selected>硅基流动</option>
                                    <option value="custom">自定义 (兼容OpenAI)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">API Key</label>
                                <div class="position-relative">
                                    <input type="password" class="form-control" id="text_processor_api_key" 
                                           placeholder="输入API Key">
                                    <button type="button" class="toggle-password" 
                                            onclick="togglePasswordVisibility('text_processor_api_key')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Base URL <span id="baseurl-required" class="text-danger" style="display:none;">*</span></label>
                                <input type="url" class="form-control" id="text_processor_base_url" 
                                       placeholder="API基础URL (硅基流动选项为可选，自定义选项为必填)">
                            </div>
                            <div class="col-12">
                                <label class="form-label">模型名称</label>
                                <input type="text" class="form-control" id="text_processor_model" 
                                       value="Qwen/Qwen3-Coder-30B-A3B-Instruct" placeholder="模型名称">
                            </div>
                            <div class="col-12">
                                <button type="button" class="btn btn-outline-success test-button" 
                                        onclick="testConnection('text_processor')">
                                    <i class="fas fa-check-circle me-2"></i>测试连接
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Obsidian 集成配置 -->
                    <div class="api-section">
                        <h5 class="mb-3">
                            <i class="fas fa-book me-2"></i>Obsidian 集成配置
                            <span class="status-indicator status-untested" id="obsidian-status"></span>
                            <small class="text-muted" id="obsidian-status-text">可选配置</small>
                        </h5>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>说明：</strong>配置Obsidian集成后，可以直接将处理结果导入到Obsidian中。支持自定义保存路径和文件名格式。
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Obsidian仓库名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="obsidian_vault_name" 
                                       placeholder="例如：MyVault 或 知识库" required>
                                <div class="form-text text-muted">
                                    <i class="fas fa-vault me-1"></i>
                                    输入您的Obsidian仓库名称（必需），通常与文件夹名称相同
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">默认保存文件夹</label>
                                <input type="text" class="form-control" id="obsidian_default_folder" 
                                       placeholder="例如：Videos/学习笔记 或 学习笔记（留空保存到根目录）">
                                <div class="form-text text-muted">
                                    <i class="fas fa-folder me-1"></i>
                                    输入Obsidian中的文件夹路径，支持多级文件夹（用/分隔）
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">文件名前缀</label>
                                <input type="text" class="form-control" id="obsidian_filename_prefix" 
                                       placeholder="例如：视频笔记_（留空使用视频标题）">
                                <div class="form-text text-muted">
                                    可以为文件名添加前缀，便于分类管理
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">文件名格式</label>
                                <select class="form-select" id="obsidian_filename_format">
                                    <option value="title">使用视频标题</option>
                                    <option value="date_title">日期+标题</option>
                                    <option value="prefix_title">前缀+标题</option>
                                </select>
                                <div class="form-text text-muted">
                                    选择文件名的生成格式
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="obsidian_auto_open" checked>
                                    <label class="form-check-label" for="obsidian_auto_open">
                                        自动打开Obsidian创建笔记
                                    </label>
                                    <div class="form-text text-muted">
                                        取消勾选将直接下载Markdown文件而不打开Obsidian
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="button" class="btn btn-outline-info me-2" onclick="showObsidianGuide()">
                                    <i class="fas fa-question-circle me-2"></i>使用指南
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="testObsidianConfig()">
                                    <i class="fas fa-check-circle me-2"></i>测试配置
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg me-3">
                            <i class="fas fa-save me-2"></i>保存配置
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg me-3" onclick="loadConfig()">
                            <i class="fas fa-refresh me-2"></i>重新加载
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-lg" onclick="clearConfig()">
                            <i class="fas fa-trash me-2"></i>清除所有配置
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
</body>
</html>